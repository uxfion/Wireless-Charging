/*
 * @文件       my_delay.c
 * @作者       董少俊
 * @功能       用定时器4 实现的延时函数
 * @完成时间   2020-4-11
 */

#include "MY_delay.h"




//-------------------------------------------------------------------------------------------------------------------
//  @函数功能            延时初始化函数
//  @变量        无
//  note: 		必须要调用 
//-------------------------------------------------------------------------------------------------------------------
void Delay_Init(void)
{
	u8 temp;
	temp=T4T3M;
	temp&=(~T4R);	//关闭定时器4
	temp&=(~T4_CT);	//定时器
//	temp|=T4x12;	//1分频
	temp&=(~T4x12);	//12分频
	temp&=(T4CLKO);	//关闭时钟输出
	T4T3M=temp;
}

//-------------------------------------------------------------------------------------------------------------------
//  @函数功能            延时1us
//  note:
//-------------------------------------------------------------------------------------------------------------------
void Delay1us(void)
{
	u8 temp; 
	TH4=0xff;
	TL4=0xfd;
	temp=T4T3M;
	temp|=T4R;	//开启定时器4
	T4T3M=temp;
	while(1)
	{
		temp=AUXINTIF;
		if(temp&T4IF)//读取中断标志位
		{
			temp&=(~T4IF);	//清除中断标志位
			AUXINTIF=temp;
			
			temp=T4T3M;
			temp&=(~T4R);	//关闭定时器4
			T4T3M=temp;
			break;
		}	
	}
}

//-------------------------------------------------------------------------------------------------------------------
//  @函数功能            延时1ms
//  note:
//-------------------------------------------------------------------------------------------------------------------
void Delay1ms(void)
{
	u8 temp; 
	TH4=0xf8;
	TL4=0x2f;
	temp=T4T3M;
	temp|=T4R;	//开启定时器4
	T4T3M=temp;
	while(1)
	{
		temp=AUXINTIF;
		if(temp&T4IF)//读取中断标志位
		{
			temp&=(~T4IF);	//清除中断标志位
			AUXINTIF=temp;
			
			temp=T4T3M;
			temp&=(~T4R);	//关闭定时器4
			T4T3M=temp;
			break;
		}	
	}
}

//-------------------------------------------------------------------------------------------------------------------
//  @函数功能            延时us
//	@变量		u32		 us
//  note:
//-------------------------------------------------------------------------------------------------------------------
void Delay_us(u32 us)
{
	while(us)
	{
		Delay1us();
		us--;
	}
}

//-------------------------------------------------------------------------------------------------------------------
//  @函数功能            延时ms
//	@变量		u32		 ms
//  note:
//-------------------------------------------------------------------------------------------------------------------
void Delay_ms(u32 ms)
{
	while(ms)
	{
		Delay1ms();
		ms--;
	}
}